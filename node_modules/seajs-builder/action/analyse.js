var fs = require('fs');
var path = require('path');
var uglifyjs = require('uglify-js');
var console = require('./console.js');


var mod = {
    getCodeDependencies: function (code, baseDir, dir) {
        var ast;
        var deps = [];

        try {
            ast = uglifyjs.parser.parse(code);
        } catch (e) {
            delete e.stack;
            console.error('syntax error: ');
            console.error(JSON.stringify(e));
            return deps;
        }

        code = uglifyjs.uglify.gen_code(ast);
        var reg = /require\(\"(.*?)\"\)/g;

        code = code.replace(reg, function (match, val) {
            var nval = match;
            var fileName;

            if (val.match(/^\./)) {
                fileName = path.resolve(dir, val);
            } else {
                fileName = path.resolve(baseDir, val);
            }
            fileName = fileName.replace(/\\/g, '/');

            if (!fileName.match(/\.css$/) && !fileName.match(/\.js$/)) {
                fileName += '.js';
            }

            if (fs.existsSync(fileName)) {
                deps.push(fileName);
                nval = 'require("' + fileName + '")';
            } else {
                console.error('file can\'t find: "' + fileName + '"');
            }

            return nval;
        });

        return {
            code: code,
            deps: deps
        };
    },
    getFileDependencies: function (fileName, baseDir) {
        // file
        if (!fs.existsSync(fileName)) {
            console.error('can\'t find the file "' + fileName + '".');
            return;
        }
        
        // baseDir
        if (baseDir === undefined) {
            baseDir = path.dirname(fileName);
        }
        if (!fs.existsSync(baseDir)) {
            console.error('can\'t find the base dir \'' + baseDir + '\'.');
            return;
        }

        var code = fs.readFileSync(fileName, 'utf8');
        var dir = path.dirname(fileName);

        var deps;
        if (fileName.match(/\.css$/)) {
            deps = require('./css-analyse.js').getCodeDependencies(code, baseDir, dir);
            deps.code = deps.code.replace(/define\(function/, 'define("' + path.resolve(fileName).replace(/\\/g, '/') + '", function');
        } else {
            deps = this.getCodeDependencies(code, baseDir, dir);
            deps.code = deps.code.replace(/define\(function/, 'define("' + path.resolve(fileName).replace(/\\/g, '/') + '", function');
        }

        return deps;
    }
};


module.exports = mod;
