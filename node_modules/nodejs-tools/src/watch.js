var _ = require('./underscore.v1.4.4.min.js');
var fs = require('fs');


var getWatchMap = function (dirname) {
    var map = {};

    var walk = function (dir) {
        fs.readdirSync(dir).forEach(function (item) {
            var fileName = dir.replace(/\\/g, '\/') + '/' + item;
            var stat = fs.statSync(fileName);
            if (!stat.isDirectory()) {
                map[fileName] = +stat.mtime;
                return;
            }

            walk(fileName);
        });
    };
    walk(dirname);

    return map;
};


var watch = function (path, fn) {
    if (!fs.existsSync(path)) {
        console.error('can\'t find the file. "' + path + '"');
        return;
    }

    if (!fs.statSync(path).isDirectory()) {
        console.error('is not directory. "' + path + '"');
        return;
    }

    var oriMap = getWatchMap(path);

    var redo = function () {
        var newMap = getWatchMap(path);

        var data = {};
        var keys = _.union(_.keys(oriMap), _.keys(newMap));
        _.each(keys, function (key) {
            if (oriMap[key] === undefined && newMap[key] !== undefined) {
                data[key] = 'add';
                return;
            }
            if (oriMap[key] !== undefined && newMap[key] === undefined) {
                data[key] = 'del';
                return;
            }
            if (oriMap[key] !== undefined && newMap[key] !== undefined && oriMap[key] !== newMap[key]) {
                data[key] = 'edit';
                return;
            }
        });
        oriMap = newMap;

        if (_.keys(data).length !== 0) {
            fn(data);
        }

        setTimeout(redo, 500);
    };

    redo();
};


module.exports = watch;
